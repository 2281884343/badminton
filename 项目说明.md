# 羽毛球游戏项目说明

## 项目概述

这是一个基于Web的羽毛球跑团游戏，支持1v1单打和2v2双打模式。玩家通过随机数判定进行击球，配合AI生成的比赛解说，带来独特的游戏体验。

## 核心特性

### 🎲 跑团机制
- 每次击球投掷1-20的随机数
- 技能熟练度影响最终判定结果
- 高低质量球有不同的对抗判定

### 🤖 AI解说
- 使用Moonshot AI (Kimi K2-Turbo)
- 每一球都生成20字以内的生动描述
- 根据比分和局势调整解说风格

### 📊 技能系统
- 10种羽毛球技术动作
- 每个技能独立设置熟练度（-100到100）
- 熟练度影响随机数浮动和大成功/大失败判定

### 🌐 网络对战
- WebSocket实时通信
- 支持多人同时在线
- 房间系统管理对战

## 技术实现

### 后端架构 (FastAPI)

```
backend/main.py
├── FastAPI应用初始化
├── CORS中间件配置
├── OpenAI客户端（Moonshot AI）
├── 游戏房间管理（GameRoom类）
├── API端点
│   ├── /api/player/save - 保存玩家配置
│   ├── /api/player/{username} - 获取玩家配置
│   ├── /api/skills - 获取技能列表
│   ├── /api/room/create - 创建房间
│   └── /api/rooms - 列出房间
├── WebSocket端点
│   └── /ws/{room_id}/{username}
└── 游戏逻辑函数
    ├── calculate_shot_result() - 计算击球结果
    ├── can_receive_shot() - 判断是否接住
    ├── generate_ai_description() - AI描述生成
    └── handle_game_action() - 处理游戏动作
```

### 前端架构 (React + TypeScript)

```
frontend/src/
├── App.tsx - 主应用组件，管理游戏状态
├── components/
│   ├── PlayerSetup.tsx - 玩家配置界面
│   │   ├── 用户名输入
│   │   ├── 技能熟练度设置
│   │   └── 加载/保存配置
│   ├── GameLobby.tsx - 游戏大厅
│   │   ├── 模式选择（单打/双打）
│   │   ├── 创建房间
│   │   └── 加入房间
│   └── GameRoom.tsx - 游戏房间
│       ├── WebSocket连接管理
│       ├── 比分显示
│       ├── 玩家列表
│       ├── 技能选择和击球
│       └── 比赛记录日志
└── index.css - 全局样式
```

## 游戏流程

### 1. 玩家配置阶段
```
用户输入用户名 → 设置10种技能熟练度 → 保存到JSON文件
```

### 2. 房间匹配阶段
```
选择模式（单打/双打） → 创建或加入房间 → 等待玩家加入 → 开始游戏
```

### 3. 游戏进行阶段
```
玩家回合 → 选择技能 → 输入对话 → 击球
    ↓
投掷基础随机数(1-20)
    ↓
应用熟练度浮动
    ↓
应用低质量球加成
    ↓
计算最终随机数
    ↓
判定球的质量
    ↓
调用AI生成描述
    ↓
判断对方是否能接住
    ↓
更新比分（如得分）
    ↓
检查是否游戏结束(21分)
```

## 随机数判定详解

### 基础投掷
```python
base_roll = random.randint(1, 20)  # 1-20随机数
```

### 熟练度浮动
```python
float_range = abs(skill_level) // 30  # 每30点增加1点浮动
float_value = random.randint(0, float_range)

if skill_level >= 0:
    adjusted_roll = base_roll + float_value  # 正熟练度增加
else:
    adjusted_roll = base_roll - float_value  # 负熟练度减少
```

### 低质量球加成
```python
if opponent_last_quality == "low":
    bonus = opponent_last_value // 4
    final_roll = adjusted_roll + bonus
```

### 特殊判定

**大失败（Critical Fail）：**
- 普通：base_roll == 1
- 熟练度≥80：需要连续两次投1

**大成功（Critical Success）：**
- 普通：base_roll == 20
- 熟练度≥90：base_roll >= 19

**球质量分类：**
- `critical_fail`: 最终≤1
- `low`: 最终<9
- `normal`: 9≤最终<15
- `high`: 15≤最终<20（或未大成功）
- `critical_success`: 大成功判定

## AI描述生成

### Prompt结构
```python
f"""请用20字以内描述这一球的情况。
技术动作：{skill}
随机数：{final_roll}（基础：{base_roll}）
球质量：{quality}
当前比分：{score_a}:{score_b}

要求：
1. 描述要简洁生动
2. 根据随机数高低描述球的质量
3. 如果是关键分，增加紧张氛围
4. 不要超过20个字"""
```

### 降级策略
如果AI调用失败，使用本地简单描述：
```python
quality_desc = {
    "critical_fail": "失误！",
    "low": "质量不佳",
    "normal": "稳健回击",
    "high": "精彩好球！",
    "critical_success": "完美击球！"
}
return f"{skill}，{quality_desc[quality]}（{final_roll}）"
```

## 数据存储

### 玩家配置文件
位置：`backend/data/players/{username}.json`

```json
{
  "username": "张三",
  "skills": {
    "发球": 80,
    "接发球": 70,
    "高远球": 60,
    "杀球": 90,
    "吊球": 65,
    "挑球": 55,
    "放网": 45,
    "扑球": 50,
    "勾球": 40,
    "搓球": 35
  },
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T10:00:00"
}
```

## WebSocket通信协议

### 客户端 → 服务器

**开始游戏：**
```json
{"type": "start_game"}
```

**击球动作：**
```json
{
  "type": "shot",
  "skill": "杀球",
  "message": "看我这记重扣！"
}
```

### 服务器 → 客户端

**玩家加入：**
```json
{
  "type": "player_joined",
  "username": "张三",
  "players": ["张三", "李四"],
  "player_count": 2
}
```

**击球结果：**
```json
{
  "type": "shot_result",
  "player": "张三",
  "skill": "杀球",
  "message": "看我这记重扣！",
  "result": {
    "base_roll": 18,
    "adjusted_roll": 19,
    "final_roll": 19,
    "quality": "high",
    "is_critical_fail": false,
    "is_critical_success": false
  },
  "description": "强力杀球，球速极快！",
  "scored": false,
  "game_state": {...}
}
```

**游戏结束：**
```json
{
  "type": "shot_result",
  ...,
  "game_over": true,
  "game_state": {
    "status": "finished",
    "score_a": 21,
    "score_b": 18
  }
}
```

## 性能优化

### 1. AI调用优化
- 使用`temperature=0.8`平衡创意和稳定性
- `max_tokens=50`限制输出长度
- 实现降级策略防止API失败影响游戏

### 2. WebSocket优化
- 使用JSON序列化减少数据大小
- 异步处理避免阻塞
- 错误处理和自动重连

### 3. 前端优化
- React状态管理避免不必要的重渲染
- 日志自动滚动到最新
- WebSocket连接状态显示

## 扩展性设计

### 可扩展点

1. **新技术动作**：在`SKILLS`列表添加即可
2. **新游戏模式**：修改房间逻辑支持更多模式
3. **新AI提供商**：替换OpenAI客户端配置
4. **持久化数据库**：替换文件存储为PostgreSQL/MongoDB
5. **用户认证**：添加JWT认证中间件
6. **排行榜系统**：记录比赛结果并展示

## 测试建议

### 单人测试
1. 启动后端和前端
2. 打开浏览器创建玩家1
3. 打开无痕窗口创建玩家2
4. 测试完整游戏流程

### 多人测试
1. 部署到服务器
2. 多人通过网络加入同一房间
3. 测试网络延迟和同步

### 压力测试
1. 使用工具模拟多个WebSocket连接
2. 测试服务器并发处理能力
3. 监控AI API调用频率和成本

## 常见问题排查

### WebSocket连接失败
- 检查后端是否运行在8000端口
- 检查防火墙设置
- 查看浏览器控制台错误信息

### AI描述无法生成
- 验证API密钥是否有效
- 检查网络连接
- 查看后端日志错误信息

### 玩家配置无法保存
- 检查`backend/data/players/`目录权限
- 验证JSON格式是否正确
- 查看后端日志

## 未来改进方向

1. **视觉效果**：添加球场动画和击球特效
2. **声音效果**：击球音效和背景音乐
3. **录像回放**：保存比赛记录并支持回放
4. **社交功能**：好友系统、聊天室
5. **移动端适配**：响应式设计或独立App
6. **AI对战**：单人模式对抗AI
7. **锦标赛模式**：多轮淘汰赛
8. **自定义规则**：允许玩家调整游戏参数

## 技术亮点

✨ **React + TypeScript**：类型安全的前端开发
✨ **FastAPI + WebSocket**：高性能实时通信
✨ **AI集成**：自然语言描述增强体验
✨ **跑团机制**：独特的游戏玩法
✨ **技能系统**：深度的策略性和可玩性

---

**开发时间**：约2-3小时
**代码行数**：约1500行
**支持平台**：Windows/Linux/Mac
**浏览器要求**：支持WebSocket的现代浏览器

